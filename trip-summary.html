<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trip Summary - NST Travels</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    /* Same CSS as before */
    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      background-color: #f3f4f6;
      font-weight: 600;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 98vw;
      margin: auto;
      padding: 2.5rem 1rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      transition: background 0.3s, color 0.3s;
    }
    /* ... (rest of the CSS remains unchanged) */
  </style>
</head>
<body>
  <button id="themeToggle" class="fixed top-4 left-4 z-50 btn bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 px-3 py-2 rounded-md shadow hover:bg-gray-300 dark:hover:bg-gray-600 transition">
    <i class="fas fa-moon"></i>
  </button>

  <div class="container max-w-7xl mx-auto py-8">
    <a href="admin-panel.html" class="admin-link btn bg-gray-800 text-white px-4 py-2 rounded-md hover:bg-gray-900">
      <i class="fas fa-cog mr-2"></i> Admin Panel
    </a>
    <h3 class="text-3xl font-bold text-gray-900 mb-8"><i class="fas fa-table mr-2"></i> Trip Summary</h3>
    <div class="flex flex-wrap gap-4 mb-6 items-center">
      <input type="text" id="searchInput" class="input-field search-bar" placeholder="Search trips..." />
      <select id="driverFilter" class="select-field filter-select">
        <option value="">All Drivers</option>
      </select>
      <select id="vehicleFilter" class="select-field filter-select">
        <option value="">All Vehicles</option>
      </select>
      <select id="paymentFilter" class="select-field filter-select">
        <option value="">All Payments</option>
        <option value="Paid">Paid</option>
        <option value="Not Paid">Not Paid</option>
        <option value="Partially Paid">Partially Paid</option>
      </select>
      <input type="date" id="fromDate" class="input-field filter-select" />
      <input type="date" id="toDate" class="input-field filter-select" />
      <button id="clearFilters" class="btn bg-gray-300 text-gray-800 px-3 py-2 rounded-md hover:bg-gray-400">Clear</button>
      <button id="exportPDF" class="btn export-btn px-3 py-2 rounded-md"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
      <button id="exportExcel" class="btn export-btn px-3 py-2 rounded-md"><i class="fas fa-file-excel mr-1"></i> Excel</button>
      <button id="syncSheets" class="btn export-btn px-3 py-2 rounded-md"><i class="fas fa-sync mr-1"></i> Sync with Sheets</button>
    </div>
    <div class="responsive-table">
      <table id="tripTable" class="bg-white rounded-lg shadow border">
        <thead>
          <tr id="tripTableHeader">
            <th>Trip ID<div class="resize-handle"></div></th>
            <th class="trip-date-col">Trip Dates<div class="resize-handle"></div></th>
            <th>Duty<div class="resize-handle"></div></th>
            <th>Reference<div class="resize-handle"></div></th>
            <th>Pickup<div class="resize-handle"></div></th>
            <th>Drop<div class="resize-handle"></div></th>
            <th>Customer Name<div class="resize-handle"></div></th>
            <th>Customer Number<div class="resize-handle"></div></th>
            <th>Driver Name<div class="resize-handle"></div></th>
            <th>Driver Number<div class="resize-handle"></div></th>
            <th>Vehicle Model<div class="resize-handle"></div></th>
            <th>Vehicle Number<div class="resize-handle"></div></th>
            <th>Start Time<div class="resize-handle"></div></th>
            <th>End Time<div class="resize-handle"></div></th>
            <th>Duration<div class="resize-handle"></div></th>
            <th>Extra Hours<div class="resize-handle"></div></th>
            <th>Start KM<div class="resize-handle"></div></th>
            <th>End KM<div class="resize-handle"></div></th>
            <th>Total KM<div class="resize-handle"></div></th>
            <th>Extra KM<div class="resize-handle"></div></th>
            <th>Parking<div class="resize-handle"></div></th>
            <th>Toll<div class="resize-handle"></div></th>
            <th>Total Amount<div class="resize-handle"></div></th>
            <th>Paid Amount<div class="resize-handle"></div></th>
            <th>Balance Amount<div class="resize-handle"></div></th>
            <th>Payment Status<div class="resize-handle"></div></th>
            <th>Notes<div class="resize-handle"></div></th>
            <th>Files<div class="resize-handle"></div></th>
            <th>Actions<div class="resize-handle"></div></th>
          </tr>
        </thead>
        <tbody id="tripTableBody"></tbody>
        <tfoot>
          <tr id="sumRow" class="sum-row"></tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4">Edit Trip</h2>
      <form id="editForm">
        <input type="hidden" id="editTripId" name="tripId" />
        <label for="editDate">Trip Date</label>
        <input type="date" id="editDate" name="date" />
        <label for="editDuty">Duty</label>
        <input type="text" id="editDuty" name="duty" />
        <label for="editReference">Reference</label>
        <input type="text" id="editReference" name="reference" />
        <label for="editPickupLocation">Pickup Location</label>
        <input type="text" id="editPickupLocation" name="pickupLocation" />
        <label for="editDropLocation">Drop Location</label>
        <input type="text" id="editDropLocation" name="dropLocation" />
        <label for="editCustomerName">Customer Name</label>
        <input type="text" id="editCustomerName" name="customerName" />
        <label for="editCustomerNumber">Customer Number</label>
        <input type="text" id="editCustomerNumber" name="customerNumber" />
        <label for="editDriverName">Driver Name</label>
        <input type="text" id="editDriverName" name="driverName" />
        <label for="editDriverNumber">Driver Number</label>
        <input type="text" id="editDriverNumber" name="driverNumber" />
        <label for="editVehicleModel">Vehicle Model</label>
        <input type="text" id="editVehicleModel" name="vehicleModel" />
        <label for="editVehicleNumber">Vehicle Number</label>
        <input type="text" id="editVehicleNumber" name="vehicleNumber" />
        <label for="editStartTime">Start Time</label>
        <input type="time" id="editStartTime" name="startTime" />
        <label for="editEndTime">End Time</label>
        <input type="time" id="editEndTime" name="endTime" />
        <label for="editDuration">Duration</label>
        <input type="text" id="editDuration" name="duration" />
        <label for="editExtraHours">Extra Hours</label>
        <input type="number" id="editExtraHours" name="extraHours" />
        <label for="editStartKm">Start KM</label>
        <input type="number" id="editStartKm" name="startKm" />
        <label for="editEndKm">End KM</label>
        <input type="number" id="editEndKm" name="endKm" />
        <label for="editTotalKm">Total KM</label>
        <input type="number" id="editTotalKm" name="totalKm" />
        <label for="editExtraKm">Extra KM</label>
        <input type="number" id="editExtraKm" name="extraKm" />
        <label for="editParking">Parking</label>
        <input type="number" id="editParking" name="parking" />
        <label for="editToll">Toll</label>
        <input type="number" id="editToll" name="toll" />
        <label for="editTotalAmount">Total Amount</label>
        <input type="number" id="editTotalAmount" name="totalAmount" />
        <label for="editPaidAmount">Paid Amount</label>
        <input type="number" id="editPaidAmount" name="paidAmount" />
        <label for="editBalanceAmount">Balance Amount</label>
        <input type="number" id="editBalanceAmount" name="balanceAmount" />
        <label for="editPaymentStatus">Payment Status</label>
        <select id="editPaymentStatus" name="paymentStatus">
          <option value="">Select Status</option>
          <option value="Paid">Paid</option>
          <option value="Not Paid">Not Paid</option>
          <option value="Partially Paid">Partially Paid</option>
        </select>
        <label for="editTripNotes">Notes</label>
        <textarea id="editTripNotes" name="tripNotes" rows="4"></textarea>
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" id="cancelEdit" class="btn bg-gray-300 text-gray-800 px-3 py-2 rounded-md hover:bg-gray-400">Cancel</button>
          <button type="submit" class="btn bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <footer class="bg-gray-800 text-white py-6 mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p class="footer-text">Â© 2025 NST Travels. All rights reserved.</p>
    </div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, child, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCz2rGDr0iREns6Rg6r1z5EHE3qhLDnEzs",
      authDomain: "narayananselvitravels-26dcb.firebaseapp.com",
      databaseURL: "https://narayananselvitravels-26dcb-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "narayananselvitravels-26dcb",
      storageBucket: "narayananselvitravels-26dcb.appspot.com",
      messagingSenderId: "395599682835",
      appId: "1:395599682835:web:9d46e03ca14aa0738dcee6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db);

    // Google Sheets configuration
    const SPREADSHEET_ID = '1L1M8IHhGdWFO-O4GqhemoEhMGTjYNmxWaKG5b6YSM_I';
    const SHEET_NAME = 'Trips'; // Update if your sheet name is different
    const FIREBASE_FUNCTION_URL = 'https://us-central1-narayananselvitravels-26dcb.cloudfunctions.net/syncToGoogleSheets'; // Update with your Firebase Function URL

    let allTrips = [];
    let sortCol = null;
    let sortDir = 1;

    const sheetHeaders = [
      "Trip ID", "Trip Dates", "Duty", "Reference", "Pickup", "Drop", "Customer Name", "Customer Number",
      "Driver Name", "Driver Number", "Vehicle Model", "Vehicle Number", "Start Time", "End Time", "Duration",
      "Extra Hours", "Start KM", "End KM", "Total KM", "Extra KM", "Parking", "Toll", "Total Amount",
      "Paid Amount", "Balance Amount", "Payment Status", "Notes", "Files", "Firebase ID"
    ];

    // Dark Mode Toggle
    const themeToggle = document.getElementById('themeToggle');
    const htmlEl = document.documentElement;
    function updateThemeIcon() {
      if (htmlEl.classList.contains('dark')) {
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
      }
    }
    if (localStorage.getItem('theme') === 'dark' ||
        (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      htmlEl.classList.add('dark');
    }
    updateThemeIcon();
    themeToggle.addEventListener('click', () => {
      htmlEl.classList.toggle('dark');
      localStorage.setItem('theme', htmlEl.classList.contains('dark') ? 'dark' : 'light');
      updateThemeIcon();
      updateModalTheme();
    });

    function updateModalTheme() {
      const modalContent = document.querySelector('.modal-content');
      if (modalContent) {
        if (htmlEl.classList.contains('dark')) {
          modalContent.classList.add('dark');
        } else {
          modalContent.classList.remove('dark');
        }
      }
    }

    function formatDateForInput(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      if (isNaN(d)) return '';
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}-${month}-${year}`;
    }

    function formatTime12(timeStr) {
      if (!timeStr) return '';
      const [h, m] = timeStr.split(':');
      let hour = parseInt(h, 10);
      const min = m ? m.padStart(2, '0') : '00';
      const ampm = hour >= 12 ? 'PM' : 'AM';
      hour = hour % 12;
      if (hour === 0) hour = 12;
      return `${hour}:${min} ${ampm}`;
    }

    function formatTimeForInput(timeStr) {
      if (!timeStr) return '';
      const [h, m] = timeStr.split(':');
      return `${h.padStart(2, '0')}:${m || '00'}`;
    }

    function groupTrips(trips) {
      const grouped = {};
      trips.forEach(trip => {
        if (!grouped[trip.bookingId]) grouped[trip.bookingId] = [];
        grouped[trip.bookingId].push(trip);
      });
      return Object.values(grouped).map(group => {
        if (group.length === 1) {
          const t = group[0];
          let tripDateCol = t.date ? formatDate(t.date) : '';
          return { ...t, tripDates: tripDateCol };
        }
        const dates = group.map(t => t.date).sort();
        const t = group[0];
        let tripDateCol = '';
        if (dates.length > 1) {
          tripDateCol = `${formatDate(dates[0])} to ${formatDate(dates[dates.length - 1])}`;
        } else {
          tripDateCol = dates[0] ? formatDate(dates[0]) : '';
        }
        const allNotes = Array.from(new Set(group.map(t => t.tripNotes).filter(Boolean))).join(' | ');
        const allFiles = Array.from(new Set(group.flatMap(t => t.tripFiles || [])));
        return {
          ...t,
          tripDates: tripDateCol,
          tripNotes: allNotes,
          tripFiles: allFiles
        };
      });
    }

    async function loadTrips() {
      try {
        const snap = await get(child(dbRef, 'trips'));
        allTrips = [];
        if (snap.exists()) {
          allTrips = Object.entries(snap.val()).map(([key, value]) => ({
            id: key,
            ...value
          }));
        }
        renderTable();
        populateFilters();
        await syncToGoogleSheets(allTrips); // Initial sync
      } catch (error) {
        console.error('Error loading trips:', error);
        alert('Failed to load trips.');
      }
    }

    function populateFilters() {
      const driverSet = new Set();
      const vehicleSet = new Set();
      allTrips.forEach(trip => {
        if (trip.driverName) driverSet.add(trip.driverName);
        if (trip.vehicleModel) vehicleSet.add(trip.vehicleModel);
      });
      const driverFilter = document.getElementById('driverFilter');
      const vehicleFilter = document.getElementById('vehicleFilter');
      driverFilter.innerHTML = '<option value="">All Drivers</option>';
      vehicleFilter.innerHTML = '<option value="">All Vehicles</option>';
      Array.from(driverSet).sort().forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        driverFilter.appendChild(opt);
      });
      Array.from(vehicleSet).sort().forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        vehicleFilter.appendChild(opt);
      });
    }

    const colKeys = [
      "bookingId", "tripDates", "duty", "reference", "pickupLocation", "dropLocation", "customerName", "customerNumber",
      "driverName", "driverNumber", "vehicleModel", "vehicleNumber", "startTime", "endTime", "duration", "extraHours",
      "startKm", "endKm", "totalKm", "extraKm", "parking", "toll", "totalAmount", "paidAmount", "balanceAmount",
      "paymentStatus", "tripNotes", "tripFiles", "id"
    ];

    function renderTable() {
      const tbody = document.getElementById('tripTableBody');
      const tfoot = document.getElementById('sumRow');
      tbody.innerHTML = '';
      tfoot.innerHTML = '';
      const search = document.getElementById('searchInput').value.toLowerCase();
      const driver = document.getElementById('driverFilter').value;
      const vehicle = document.getElementById('vehicleFilter').value;
      const payment = document.getElementById('paymentFilter').value;
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;

      let filtered = groupTrips(allTrips).filter(trip => {
        let match = true;
        if (search) {
          match = Object.values(trip).some(val => (val + '').toLowerCase().includes(search));
        }
        if (match && driver) match = trip.driverName === driver;
        if (match && vehicle) match = trip.vehicleModel === vehicle;
        if (match && payment) match = trip.paymentStatus === payment;
        if (match && fromDate) match = trip.date >= fromDate;
        if (match && toDate) match = trip.date <= toDate;
        return match;
      });

      if (sortCol !== null && sortCol < colKeys.length - 2) {
        filtered.sort((a, b) => {
          let valA = a[colKeys[sortCol]];
          let valB = b[colKeys[sortCol]];
          if (colKeys[sortCol] === "tripDates") {
            valA = a.date || "";
            valB = b.date || "";
          }
          if (!isNaN(valA) && !isNaN(valB)) {
            return (Number(valA) - Number(valB)) * sortDir;
          }
          if (valA && valB) {
            return valA.toString().localeCompare(valB.toString()) * sortDir;
          }
          if (valA) return sortDir;
          if (valB) return -sortDir;
          return 0;
        });
      }

      let totalAmount = 0, paidAmount = 0, balanceAmount = 0;
      filtered.forEach(trip => {
        totalAmount += parseFloat(trip.totalAmount) || 0;
        paidAmount += parseFloat(trip.paidAmount) || 0;
        balanceAmount += parseFloat(trip.balanceAmount) || 0;
      });

      filtered.forEach(trip => {
        let statusClass = '';
        if (trip.paymentStatus === 'Paid') statusClass = 'status-badge status-paid';
        else if (trip.paymentStatus === 'Not Paid') statusClass = 'status-badge status-notpaid';
        else if (trip.paymentStatus === 'Partially Paid') statusClass = 'status-badge status-partial';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${trip.bookingId || ''}</td>
          <td class="trip-date-col">${trip.tripDates}</td>
          <td>${trip.duty || ''}</td>
          <td>${trip.reference || ''}</td>
          <td>${trip.pickupLocation || ''}</td>
          <td>${trip.dropLocation || ''}</td>
          <td>${trip.customerName || ''}</td>
          <td>${trip.customerNumber || ''}</td>
          <td>${trip.driverName || ''}</td>
          <td>${trip.driverNumber || ''}</td>
          <td>${trip.vehicleModel || ''}</td>
          <td>${trip.vehicleNumber || ''}</td>
          <td>${formatTime12(trip.startTime)}</td>
          <td>${formatTime12(trip.endTime)}</td>
          <td>${trip.duration || ''}</td>
          <td>${trip.extraHours || ''}</td>
          <td>${trip.startKm || ''}</td>
          <td>${trip.endKm || ''}</td>
          <td>${trip.totalKm || ''}</td>
          <td>${trip.extraKm || ''}</td>
          <td>${trip.parking || ''}</td>
          <td>${trip.toll || ''}</td>
          <td>${trip.totalAmount || ''}</td>
          <td>${trip.paidAmount || ''}</td>
          <td>${trip.balanceAmount || ''}</td>
          <td><span class="${statusClass}">${trip.paymentStatus || ''}</span></td>
          <td>${trip.tripNotes ? trip.tripNotes.replace(/\n/g, '<br>') : ''}</td>
          <td>${(trip.tripFiles && trip.tripFiles.length) ? trip.tripFiles.map(f => `<span class="inline-block bg-gray-200 dark:bg-gray-700 rounded px-2 py-1 m-1">${f}</span>`).join('') : ''}</td>
          <td>
            <button class="action-btn edit-btn" data-id="${trip.id}"><i class="fas fa-edit"></i> Edit</button>
            <button class="action-btn delete-btn" data-id="${trip.id}"><i class="fas fa-trash"></i> Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      let sumRow = '';
      for (let i = 0; i < 29; i++) {
        if (i === 22) sumRow += `<td class="sum-row">${totalAmount.toFixed(2)}</td>`;
        else if (i === 23) sumRow += `<td class="sum-row">${paidAmount.toFixed(2)}</td>`;
        else if (i === 24) sumRow += `<td class="sum-row">${balanceAmount.toFixed(2)}</td>`;
        else if (i === 0) sumRow += `<td class="sum-row" colspan="22" style="text-align:right;">Total</td>`;
        else if (i > 24) sumRow += `<td class="sum-row"></td>`;
      }
      tfoot.innerHTML = sumRow;

      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.removeEventListener('click', handleEditClick);
        btn.addEventListener('click', handleEditClick);
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.removeEventListener('click', handleDeleteClick);
        btn.addEventListener('click', handleDeleteClick);
      });
    }

    function handleEditClick(event) {
      const tripId = event.currentTarget.dataset.id;
      console.log('Edit button clicked for tripId:', tripId);
      openEditModal(tripId);
    }

    async function handleDeleteClick(event) {
      const tripId = event.currentTarget.dataset.id;
      console.log('Delete button clicked for tripId:', tripId);
      await deleteTrip(tripId);
    }

    function openEditModal(tripId) {
      console.log('Opening edit modal for tripId:', tripId);
      const trip = allTrips.find(t => t.id === tripId);
      if (!trip) {
        console.error('Trip not found for id:', tripId);
        alert('Trip not found.');
        return;
      }

      document.getElementById('editTripId').value = trip.id;
      document.getElementById('editDate').value = formatDateForInput(trip.date) || '';
      document.getElementById('editDuty').value = trip.duty || '';
      document.getElementById('editReference').value = trip.reference || '';
      document.getElementById('editPickupLocation').value = trip.pickupLocation || '';
      document.getElementById('editDropLocation').value = trip.dropLocation || '';
      document.getElementById('editCustomerName').value = trip.customerName || '';
      document.getElementById('editCustomerNumber').value = trip.customerNumber || '';
      document.getElementById('editDriverName').value = trip.driverName || '';
      document.getElementById('editDriverNumber').value = trip.driverNumber || '';
      document.getElementById('editVehicleModel').value = trip.vehicleModel || '';
      document.getElementById('editVehicleNumber').value = trip.vehicleNumber || '';
      document.getElementById('editStartTime').value = formatTimeForInput(trip.startTime) || '';
      document.getElementById('editEndTime').value = formatTimeForInput(trip.endTime) || '';
      document.getElementById('editDuration').value = trip.duration || '';
      document.getElementById('editExtraHours').value = trip.extraHours || '';
      document.getElementById('editStartKm').value = trip.startKm || '';
      document.getElementById('editEndKm').value = trip.endKm || '';
      document.getElementById('editTotalKm').value = trip.totalKm || '';
      document.getElementById('editExtraKm').value = trip.extraKm || '';
      document.getElementById('editParking').value = trip.parking || '';
      document.getElementById('editToll').value = trip.toll || '';
      document.getElementById('editTotalAmount').value = trip.totalAmount || '';
      document.getElementById('editPaidAmount').value = trip.paidAmount || '';
      document.getElementById('editBalanceAmount').value = trip.balanceAmount || '';
      document.getElementById('editPaymentStatus').value = trip.paymentStatus || '';
      document.getElementById('editTripNotes').value = trip.tripNotes || '';

      const modal = document.getElementById('editModal');
      if (modal) {
        modal.style.display = 'flex';
        console.log('Modal display set to flex');
      } else {
        console.error('Edit modal not found in DOM');
        alert('Error: Edit modal not found.');
      }
      updateModalTheme();
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const tripId = document.getElementById('editTripId').value;
      console.log('Saving trip for tripId:', tripId);
      const updatedTrip = {
        bookingId: allTrips.find(t => t.id === tripId).bookingId,
        date: document.getElementById('editDate').value || null,
        duty: document.getElementById('editDuty').value || null,
        reference: document.getElementById('editReference').value || null,
        pickupLocation: document.getElementById('editPickupLocation').value || null,
        dropLocation: document.getElementById('editDropLocation').value || null,
        customerName: document.getElementById('editCustomerName').value || null,
        customerNumber: document.getElementById('editCustomerNumber').value || null,
        driverName: document.getElementById('editDriverName').value || null,
        driverNumber: document.getElementById('editDriverNumber').value || null,
        vehicleModel: document.getElementById('editVehicleModel').value || null,
        vehicleNumber: document.getElementById('editVehicleNumber').value || null,
        startTime: document.getElementById('editStartTime').value || null,
        endTime: document.getElementById('editEndTime').value || null,
        duration: document.getElementById('editDuration').value || null,
        extraHours: document.getElementById('editExtraHours').value || null,
        startKm: document.getElementById('editStartKm').value || null,
        endKm: document.getElementById('editEndKm').value || null,
        totalKm: document.getElementById('editTotalKm').value || null,
        extraKm: document.getElementById('editExtraKm').value || null,
        parking: document.getElementById('editParking').value || null,
        toll: document.getElementById('editToll').value || null,
        totalAmount: document.getElementById('editTotalAmount').value || null,
        paidAmount: document.getElementById('editPaidAmount').value || null,
        balanceAmount: document.getElementById('editBalanceAmount').value || null,
        paymentStatus: document.getElementById('editPaymentStatus').value || null,
        tripNotes: document.getElementById('editTripNotes').value || null,
        tripFiles: allTrips.find(t => t.id === tripId).tripFiles || []
      };

      try {
        await set(ref(db, `trips/${tripId}`), updatedTrip);
        console.log('Trip updated successfully:', tripId);
        alert('Trip updated successfully!');
        document.getElementById('editModal').style.display = 'none';
        document.getElementById('editForm').reset();
        await loadTrips();
      } catch (error) {
        console.error('Error updating trip:', error);
        alert('Failed to update trip.');
      }
    });

    document.getElementById('cancelEdit').addEventListener('click', () => {
      console.log('Cancel edit clicked');
      const modal = document.getElementById('editModal');
      modal.style.display = 'none';
      document.getElementById('editForm').reset();
    });

    async function deleteTrip(tripId) {
      console.log('Deleting trip:', tripId);
      if (!confirm('Are you sure you want to delete this trip?')) return;
      try {
        await remove(ref(db, `trips/${tripId}`));
        console.log('Trip deleted successfully:', tripId);
        alert('Trip deleted successfully!');
        await loadTrips();
      } catch (error) {
        console.error('Error deleting trip:', error);
        alert('Failed to delete trip.');
      }
    }

    async function syncToGoogleSheets(trips) {
      try {
        const response = await fetch(FIREBASE_FUNCTION_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'syncAll',
            spreadsheetId: SPREADSHEET_ID,
            sheetName: SHEET_NAME,
            trips: trips.map(trip => ({
              id: trip.id,
              bookingId: trip.bookingId || '',
              tripDates: trip.date ? formatDate(trip.date) : '',
              duty: trip.duty || '',
              reference: trip.reference || '',
              pickupLocation: trip.pickupLocation || '',
              dropLocation: trip.dropLocation || '',
              customerName: trip.customerName || '',
              customerNumber: trip.customerNumber || '',
              driverName: trip.driverName || '',
              driverNumber: trip.driverNumber || '',
              vehicleModel: trip.vehicleModel || '',
              vehicleNumber: trip.vehicleNumber || '',
              startTime: formatTime12(trip.startTime) || '',
              endTime: formatTime12(trip.endTime) || '',
              duration: trip.duration || '',
              extraHours: trip.extraHours || '',
              startKm: trip.startKm || '',
              endKm: trip.endKm || '',
              totalKm: trip.totalKm || '',
              extraKm: trip.extraKm || '',
              parking: trip.parking || '',
              toll: trip.toll || '',
              totalAmount: trip.totalAmount || '',
              paidAmount: trip.paidAmount || '',
              balanceAmount: trip.balanceAmount || '',
              paymentStatus: trip.paymentStatus || '',
              tripNotes: trip.tripNotes || '',
              tripFiles: (trip.tripFiles || []).join(', ')
            }))
          })
        });
        const result = await response.json();
        if (result.success) {
          console.log('Synced all trips to Google Sheets');
        } else {
          console.error('Error syncing to Google Sheets:', result.error);
          alert('Failed to sync to Google Sheets.');
        }
      } catch (error) {
        console.error('Error syncing to Google Sheets:', error);
        alert('Failed to sync to Google Sheets.');
      }
    }

    document.getElementById('syncSheets').addEventListener('click', async () => {
      await syncToGoogleSheets(allTrips);
      alert('Manually synced to Google Sheets!');
    });

    // Real-time Firebase listener
    onValue(ref(db, 'trips'), async (snapshot) => {
      allTrips = [];
      if (snapshot.exists()) {
        allTrips = Object.entries(snapshot.val()).map(([key, value]) => ({
          id: key,
          ...value
        }));
      }
      renderTable();
      populateFilters();
      await syncToGoogleSheets(allTrips);
    });

    // Export to PDF
    document.getElementById('exportPDF').addEventListener('click', function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: "landscape",
        unit: "pt",
        format: [1684, 1190]
      });
      const head = [sheetHeaders.slice(0, -1)];
      const body = [];
      const search = document.getElementById('searchInput').value.toLowerCase();
      const driver = document.getElementById('driverFilter').value;
      const vehicle = document.getElementById('vehicleFilter').value;
      const payment = document.getElementById('paymentFilter').value;
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;

      let filtered = groupTrips(allTrips).filter(trip => {
        let match = true;
        if (search) {
          match = Object.values(trip).some(val => (val + '').toLowerCase().includes(search));
        }
        if (match && driver) match = trip.driverName === driver;
        if (match && vehicle) match = trip.vehicleModel === vehicle;
        if (match && payment) match = trip.paymentStatus === payment;
        if (match && fromDate) match = trip.date >= fromDate;
        if (match && toDate) match = trip.date <= toDate;
        return match;
      });

      let totalAmount = 0, paidAmount = 0, balanceAmount = 0;
      filtered.forEach(trip => {
        totalAmount += parseFloat(trip.totalAmount) || 0;
        paidAmount += parseFloat(trip.paidAmount) || 0;
        balanceAmount += parseFloat(trip.balanceAmount) || 0;
      });

      filtered.forEach(trip => {
        body.push([
          trip.bookingId || '',
          trip.tripDates,
          trip.duty || '',
          trip.reference || '',
          trip.pickupLocation || '',
          trip.dropLocation || '',
          trip.customerName || '',
          trip.customerNumber || '',
          trip.driverName || '',
          trip.driverNumber || '',
          trip.vehicleModel || '',
          trip.vehicleNumber || '',
          formatTime12(trip.startTime),
          formatTime12(trip.endTime),
          trip.duration || '',
          trip.extraHours || '',
          trip.startKm || '',
          trip.endKm || '',
          trip.totalKm || '',
          trip.extraKm || '',
          trip.parking || '',
          trip.toll || '',
          trip.totalAmount || '',
          trip.paidAmount || '',
          trip.balanceAmount || '',
          trip.paymentStatus || '',
          trip.tripNotes ? trip.tripNotes.replace(/\n/g, ' ') : '',
          (trip.tripFiles && trip.tripFiles.length) ? trip.tripFiles.join(', ') : ''
        ]);
      });

      let sumRow = [];
      for (let i = 0; i < 28; i++) {
        if (i === 22) sumRow.push(totalAmount.toFixed(2));
        else if (i === 23) sumRow.push(paidAmount.toFixed(2));
        else if (i === 24) sumRow.push(balanceAmount.toFixed(2));
        else if (i === 0) sumRow.push("Total");
        else sumRow.push("");
      }
      body.push(sumRow);

      doc.autoTable({
        head: head,
        body: body,
        startY: 40,
        styles: { font: "helvetica", fontSize: 12, cellPadding: 5, halign: 'center', valign: 'middle' },
        headStyles: { fillColor: [37, 99, 235], textColor: 255, fontStyle: 'bold', halign: 'center', valign: 'middle' },
        alternateRowStyles: { fillColor: [245, 245, 245] },
        margin: { left: 10, right: 10 },
        theme: 'grid',
        didDrawPage: function (data) {
          doc.setFontSize(18);
          doc.setTextColor(40);
          doc.text("Trip Summary - NST Travels", data.settings.margin.left + 20, 28, { align: 'left' });
        }
      });
      doc.save('trip-summary.pdf');
    });

    // Export to Excel
    document.getElementById('exportExcel').addEventListener('click', function() {
      const table = document.getElementById('tripTable');
      const wb = XLSX.utils.table_to_book(table, { sheet: "Trips" });
      XLSX.writeFile(wb, 'trip-summary.xlsx');
    });

    function makeColumnsResizable(table) {
      const ths = table.querySelectorAll('th');
      ths.forEach((th, i) => {
        const handle = th.querySelector('.resize-handle');
        if (!handle) return;
        let startX, startWidth;
        handle.addEventListener('mousedown', function(e) {
          e.preventDefault();
          startX = e.clientX;
          startWidth = th.offsetWidth;
          document.body.style.cursor = 'col-resize';
          function onMouseMove(ev) {
            let newWidth = startWidth + (ev.clientX - startX);
            if (newWidth < 40) newWidth = 40;
            th.style.width = newWidth + "px";
            table.querySelectorAll('tr').forEach(row => {
              if (row.children[i]) row.children[i].style.width = newWidth + "px";
            });
          }
          function onMouseUp() {
            document.body.style.cursor = '';
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
          }
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
    }

    function makeColumnsSortable(table) {
      const ths = table.querySelectorAll('th');
      ths.forEach((th, i) => {
        th.addEventListener('click', function(e) {
          if (e.target.classList.contains('resize-handle') || i === colKeys.length - 1) return;
          if (sortCol === i) {
            sortDir = -sortDir;
          } else {
            sortCol = i;
            sortDir = 1;
          }
          ths.forEach(t => t.classList.remove('sorted-asc', 'sorted-desc'));
          th.classList.add(sortDir === 1 ? 'sorted-asc' : 'sorted-desc');
          renderTable();
        });
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      console.log('DOM fully loaded');
      const table = document.getElementById('tripTable');
      makeColumnsResizable(table);
      makeColumnsSortable(table);
      loadTrips();
    });
  </script>
</body>
</html>
