<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trip Summary - NST Travels</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      background-color: #f3f4f6;
      font-weight: 600;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 98vw;
      margin: auto;
      padding: 2.5rem 1rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      transition: background 0.3s, color 0.3s;
    }
    .responsive-table {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }
    table {
      table-layout: auto;
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    th, td {
      white-space: nowrap;
      text-align: center;
      vertical-align: middle;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: 1px solid #e5e7eb;
      background: inherit;
    }
    th {
      background: #2563eb;
      color: #fff !important;
      font-weight: 800;
      font-size: 1.05rem;
      border-bottom: 2px solid #1d4ed8;
      position: sticky;
      top: 0;
      z-index: 10;
      user-select: none;
      cursor: pointer;
      min-width: 60px;
      height: 48px;
    }
    th .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      width: 8px;
      height: 100%;
      cursor: col-resize;
      z-index: 10;
      background: transparent;
    }
    th.sorted-asc:after {
      content: " ▲";
      font-size: 1.1em;
      color: #fff;
    }
    th.sorted-desc:after {
      content: " ▼";
      font-size: 1.1em;
      color: #fff;
    }
    .trip-date-col {
      min-width: 180px;
      max-width: 260px;
      font-weight: 700;
      font-size: 1.05rem;
      letter-spacing: 0.5px;
    }
    .status-badge {
      display: inline-block;
      padding: 0.25em 0.8em;
      border-radius: 0.5em;
      font-weight: 700;
      font-size: 0.98em;
      color: #fff;
      letter-spacing: 0.5px;
    }
    .status-paid {
      background: #22c55e;
    }
    .status-notpaid {
      background: #ef4444;
    }
    .status-partial {
      background: #f59e42;
    }
    .sum-row {
      background: #e0e7ff;
      font-weight: bold;
      color: #1e40af;
    }
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      position: relative;
      width: 800px;
    }
    .modal-close, .modal-edit, .modal-delete, .modal-save, .modal-cancel {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-right: 0.5rem;
    }
    .modal-close {
      background: #ef4444;
      color: white;
    }
    .modal-close:hover {
      background: #dc2626;
    }
    .modal-edit {
      background: #2563eb;
      color: white;
    }
    .modal-edit:hover {
      background: #1d4ed8;
    }
    .modal-delete {
      background: #dc2626;
      color: white;
    }
    .modal-delete:hover {
      background: #b91c1c;
    }
    .modal-save {
      background: #22c55e;
      color: white;
    }
    .modal-save:hover {
      background: #16a34a;
    }
    .modal-cancel {
      background: #6b7280;
      color: white;
    }
    .modal-cancel:hover {
      background: #4b5563;
    }
    .modal-buttons {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
    }
    .file-link {
      color: #2563eb;
      text-decoration: underline;
      cursor: pointer;
    }
    .file-link:hover {
      color: #1d4ed8;
    }
    .modal-input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      background: #fff;
      color: #1f2937;
    }
    .modal-input:invalid {
      border-color: #ef4444;
    }
    @media (max-width: 900px) {
      .container {
        padding: 1.2rem 0.2rem;
      }
      .responsive-table {
        font-size: 0.95rem;
      }
      .trip-date-col {
        min-width: 140px;
        max-width: 220px;
        font-size: 0.98rem;
      }
      .modal-content {
        width: 95vw;
        padding: 1rem;
      }
    }
    @media (max-width: 640px) {
      .container {
        padding: 0.5rem 0.1rem;
      }
      .responsive-table {
        font-size: 0.85rem;
      }
      th, td {
        font-size: 0.85rem;
        padding: 0.3rem 0.5rem;
      }
      .trip-date-col {
        min-width: 120px;
        max-width: 180px;
        font-size: 0.92rem;
      }
    }
    html.dark body {
      background: #18181b;
      color: #f3f4f6;
    }
    html.dark .container {
      background: #23232a;
      color: #f3f4f6;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    html.dark .loading-overlay {
      background: rgba(0, 0, 0, 0.8);
    }
    html.dark .modal-content {
      background: #23232a;
      color: #f3f4f6;
    }
    html.dark .file-link {
      color: #60a5fa;
    }
    html.dark .file-link:hover {
      color: #3b82f6;
    }
    html.dark .modal-input {
      background: #18181b;
      color: #f3f4f6;
      border-color: #444;
    }
    html.dark input, html.dark select {
      background: #18181b;
      color: #f3f4f6;
      border-color: #444;
    }
    html.dark .btn {
      color: #fff;
    }
    html.dark .bg-gray-50 {
      background: #23232a !important;
    }
    html.dark .bg-white {
      background: #23232a !important;
    }
    html.dark .bg-gray-800 {
      background: #18181b !important;
    }
    html.dark .bg-blue-600 {
      background: #2563eb !important;
    }
    html.dark .text-gray-900 {
      color: #f3f4f6 !important;
    }
    html.dark .footer-text {
      color: #d1d5db;
    }
    html.dark .border {
      border-color: #444 !important;
    }
    .footer-text {
      font-size: 1rem;
      font-weight: 600;
    }
    .admin-link {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      z-index: 100;
      font-size: 1rem;
      font-weight: 700;
    }
    .export-btn {
      background: #2563eb;
      color: #fff;
      margin-right: 0.5rem;
    }
    .export-btn:hover {
      background: #1d4ed8;
    }
    .search-bar {
      max-width: 300px;
    }
    .filter-select {
      min-width: 120px;
    }
    tr:hover {
      background: #f1f5f9;
      cursor: pointer;
    }
    html.dark tr:hover {
      background: #2d3748;
    }
  </style>
</head>
<body>
  <!-- Dark Mode Toggle Button -->
  <button id="themeToggle" class="fixed top-4 left-4 z-50 btn bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 px-3 py-2 rounded-md shadow hover:bg-gray-300 dark:hover:bg-gray-600 transition">
    <i class="fas fa-moon"></i>
  </button>

  <div class="container max-w-7xl mx-auto py-8">
    <a href="admin-panel.html" class="admin-link btn bg-gray-800 text-white px-4 py-2 rounded-md hover:bg-gray-900">
      <i class="fas fa-cog mr-2"></i> Admin Panel
    </a>
    <h3 class="text-3xl font-bold text-gray-900 mb-8"><i class="fas fa-table mr-2"></i> Trip Summary</h3>
    <!-- Filters -->
    <div class="flex flex-wrap gap-4 mb-6 items-center">
      <input type="text" id="searchInput" class="input-field search-bar" placeholder="Search trips..." aria-label="Search trips" />
      <select id="driverFilter" class="select-field filter-select" aria-label="Filter by driver">
        <option value="">All Drivers</option>
      </select>
      <select id="vehicleFilter" class="select-field filter-select" aria-label="Filter by vehicle">
        <option value="">All Vehicles</option>
      </select>
      <select id="paymentFilter" class="select-field filter-select" aria-label="Filter by payment status">
        <option value="">All Payments</option>
        <option value="Paid">Paid</option>
        <option value="Not Paid">Not Paid</option>
        <option value="Partially Paid">Partially Paid</option>
      </select>
      <input type="date" id="fromDate" class="input-field filter-select" aria-label="Filter from date" />
      <input type="date" id="toDate" class="input-field filter-select" aria-label="Filter to date" />
      <button id="clearFilters" class="btn bg-gray-300 text-gray-800 px-3 py-2 rounded-md hover:bg-gray-400">Clear</button>
      <button id="exportPDF" class="btn export-btn px-3 py-2 rounded-md"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
      <button id="exportExcel" class="btn export-btn px-3 py-2 rounded-md"><i class="fas fa-file-excel mr-1"></i> Excel</button>
    </div>
    <!-- Table with Loading Overlay -->
    <div class="responsive-table">
      <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
      </div>
      <table id="tripTable" class="bg-white rounded-lg shadow border" role="grid" aria-label="Trip summary table">
        <thead>
          <tr id="tripTableHeader">
            <th scope="col">Trip ID<div class="resize-handle"></div></th>
            <th scope="col" class="trip-date-col">Trip Dates<div class="resize-handle"></div></th>
            <th scope="col">Duty<div class="resize-handle"></div></th>
            <th scope="col">Reference<div class="resize-handle"></div></th>
            <th scope="col">Pickup<div class="resize-handle"></div></th>
            <th scope="col">Drop<div class="resize-handle"></div></th>
            <th scope="col">Customer Name<div class="resize-handle"></div></th>
            <th scope="col">Customer Number<div class="resize-handle"></div></th>
            <th scope="col">Driver Name<div class="resize-handle"></div></th>
            <th scope="col">Driver Number<div class="resize-handle"></div></th>
            <th scope="col">Vehicle Model<div class="resize-handle"></div></th>
            <th scope="col">Vehicle Number<div class="resize-handle"></div></th>
            <th scope="col">Start Time<div class="resize-handle"></div></th>
            <th scope="col">End Time<div class="resize-handle"></div></th>
            <th scope="col">Duration<div class="resize-handle"></div></th>
            <th scope="col">Extra Hours<div class="resize-handle"></div></th>
            <th scope="col">Start KM<div class="resize-handle"></div></th>
            <th scope="col">End KM<div class="resize-handle"></div></th>
            <th scope="col">Total KM<div class="resize-handle"></div></th>
            <th scope="col">Extra KM<div class="resize-handle"></div></th>
            <th scope="col">Permit<div class="resize-handle"></div></th>
            <th scope="col">Toll & Parking<div class="resize-handle"></div></th>
            <th scope="col">Total Amount<div class="resize-handle"></div></th>
            <th scope="col">Paid Amount<div class="resize-handle"></div></th>
            <th scope="col">Balance Amount<div class="resize-handle"></div></th>
            <th scope="col">Payment Status<div class="resize-handle"></div></th>
            <th scope="col">Notes<div class="resize-handle"></div></th>
            <th scope="col">Files<div class="resize-handle"></div></th>
          </tr>
        </thead>
        <tbody id="tripTableBody">
          <!-- Data will be loaded here -->
        </tbody>
        <tfoot>
          <tr id="sumRow" class="sum-row"></tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Trip Details Modal -->
  <div id="tripModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <div class="modal-buttons">
        <button class="modal-edit" aria-label="Edit trip">Edit</button>
        <button class="modal-delete" aria-label="Delete trip">Delete</button>
        <button class="modal-close" aria-label="Close modal">Close</button>
        <button class="modal-save hidden" aria-label="Save changes">Save</button>
        <button class="modal-cancel hidden" aria-label="Cancel editing">Cancel</button>
      </div>
      <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Trip Details</h2>
      <div id="modalContent" class="space-y-4"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-6 mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p class="footer-text">© 2025 NST Travels. All rights reserved.</p>
    </div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, child, get, set, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCz2rGDr0iREns6Rw6r1z5EHE3qhLDnEzs",
      authDomain: "narayananselvitravels-26dcb.firebaseapp.com",
      databaseURL: "https://narayananselvitravels-26dcb-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "narayananselvitravels-26dcb",
      storageBucket: "narayananselvitravels-26dcb.appspot.com",
      messagingSenderId: "395599682835",
      appId: "1:395599682835:web:9d46e03ca14aa0738dcee6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db);

    let allTrips = [];
    let sortCol = null;
    let sortDir = 1; // 1 = asc, -1 = desc
    let currentTrip = null;

    // Dark Mode Toggle
    const themeToggle = document.getElementById('themeToggle');
    const htmlEl = document.documentElement;
    function updateThemeIcon() {
      if (htmlEl.classList.contains('dark')) {
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
      }
    }
    if (localStorage.getItem('theme') === 'dark' ||
        (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      htmlEl.classList.add('dark');
    } else {
      htmlEl.classList.remove('dark');
    }
    updateThemeIcon();
    themeToggle.addEventListener('click', () => {
      htmlEl.classList.toggle('dark');
      localStorage.setItem('theme', htmlEl.classList.contains('dark') ? 'dark' : 'light');
      updateThemeIcon();
    });

    // Helper: format date as DD-MM-YYYY
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}-${month}-${year}`;
    }

    // Helper: parse date from DD-MM-YYYY format to Date object
    function parseDateDDMMYYYY(dateStr) {
      if (!dateStr) return null;
      const [day, month, year] = dateStr.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    // Helper: format time as 12-hour
    function formatTime12(timeStr) {
      if (!timeStr) return '';
      const [h, m] = timeStr.split(':');
      let hour = parseInt(h, 10);
      const min = m ? m.padStart(2, '0') : '00';
      const ampm = hour >= 12 ? 'PM' : 'AM';
      hour = hour % 12;
      if (hour === 0) hour = 12;
      return `${hour}:${min} ${ampm}`;
    }

    // Helper: parse time from 12-hour format to HH:mm
    function parseTime12(timeStr) {
      if (!timeStr) return '';
      const [time, ampm] = timeStr.split(' ');
      let [hour, min] = time.split(':').map(Number);
      if (ampm === 'PM' && hour !== 12) hour += 12;
      if (ampm === 'AM' && hour === 12) hour = 0;
      return `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
    }

    // Group trips by bookingId for package trips
    function groupTrips(trips) {
      const grouped = {};
      trips.forEach(trip => {
        if (!grouped[trip.bookingId]) grouped[trip.bookingId] = [];
        grouped[trip.bookingId].push(trip);
      });
      return Object.values(grouped).map(group => {
        if (group.length === 1) {
          const t = group[0];
          let tripDateCol = t.date ? formatDate(t.date) : '';
          return { ...t, tripDates: tripDateCol };
        }
        const dates = group.map(t => t.date).sort();
        const t = group[0];
        let tripDateCol = '';
        if (dates.length > 1) {
          tripDateCol = `${formatDate(dates[0])} to ${formatDate(dates[dates.length - 1])}`;
        } else {
          tripDateCol = dates[0] ? formatDate(dates[0]) : '';
        }
        const allNotes = Array.from(new Set(group.map(t => t.tripNotes).filter(Boolean))).join(' | ');
        const allFiles = Array.from(new Set(group.flatMap(t => t.tripFiles || [])));
        return {
          ...t,
          tripDates: tripDateCol,
          tripNotes: allNotes,
          tripFiles: allFiles
        };
      });
    }

    // Load trips from Firebase with loading indicator
    async function loadTrips() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      loadingOverlay.style.display = 'flex';
      try {
        const snap = await get(child(dbRef, 'trips'));
        allTrips = [];
        if (snap.exists()) {
          allTrips = Object.values(snap.val());
        }
        renderTable();
        populateFilters();
      } catch (error) {
        alert('Error loading trips: ' + error.message);
      } finally {
        loadingOverlay.style.display = 'none';
      }
    }

    // Populate driver and vehicle filters
    function populateFilters() {
      const driverSet = new Set();
      const vehicleSet = new Set();
      allTrips.forEach(trip => {
        if (trip.driverName) driverSet.add(trip.driverName);
        if (trip.vehicleModel) vehicleSet.add(trip.vehicleModel);
      });
      const driverFilter = document.getElementById('driverFilter');
      const vehicleFilter = document.getElementById('vehicleFilter');
      driverFilter.innerHTML = '<option value="">All Drivers</option>';
      vehicleFilter.innerHTML = '<option value="">All Vehicles</option>';
      Array.from(driverSet).sort().forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        driverFilter.appendChild(opt);
      });
      Array.from(vehicleSet).sort().forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        vehicleFilter.appendChild(opt);
      });
    }

    // Column keys for sorting
    const colKeys = [
      "bookingId", "tripDates", "duty", "reference", "pickupLocation", "dropLocation", "customerName", "customerNumber",
      "driverName", "driverNumber", "vehicleModel", "vehicleNumber", "startTime", "endTime", "duration", "extraHours",
      "startKm", "endKm", "totalKm", "extraKm", "parking", "toll", "totalAmount", "paidAmount", "balanceAmount",
      "paymentStatus", "tripNotes", "tripFiles"
    ];

    // Debounce function for search input
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Show trip details modal (view mode)
    function showTripModal(trip, editMode = false) {
      currentTrip = trip;
      const modal = document.getElementById('tripModal');
      const modalContent = document.getElementById('modalContent');
      const editBtn = document.querySelector('.modal-edit');
      const deleteBtn = document.querySelector('.modal-delete');
      const saveBtn = document.querySelector('.modal-save');
      const cancelBtn = document.querySelector('.modal-cancel');
      let statusClass = '';
      if (trip.paymentStatus === 'Paid') statusClass = 'status-badge status-paid';
      else if (trip.paymentStatus === 'Not Paid') statusClass = 'status-badge status-notpaid';
      else if (trip.paymentStatus === 'Partially Paid') statusClass = 'status-badge status-partial';

      if (editMode) {
        modalContent.innerHTML = `
          <form id="editTripForm" class="space-y-4">
            <p><strong>Trip ID:</strong> <input type="text" name="bookingId" value="${trip.bookingId || ''}" class="modal-input" required></p>
            <p><strong>Trip Dates:</strong> <input type="text" name="tripDates" value="${trip.tripDates || ''}" class="modal-input" placeholder="DD-MM-YYYY or DD-MM-YYYY to DD-MM-YYYY"></p>
            <p><strong>Duty:</strong> <input type="text" name="duty" value="${trip.duty || ''}" class="modal-input"></p>
            <p><strong>Reference:</strong> <input type="text" name="reference" value="${trip.reference || ''}" class="modal-input"></p>
            <p><strong>Pickup:</strong> <input type="text" name="pickupLocation" value="${trip.pickupLocation || ''}" class="modal-input"></p>
            <p><strong>Drop:</strong> <input type="text" name="dropLocation" value="${trip.dropLocation || ''}" class="modal-input"></p>
            <p><strong>Customer Name:</strong> <input type="text" name="customerName" value="${trip.customerName || ''}" class="modal-input"></p>
            <p><strong>Customer Number:</strong> <input type="text" name="customerNumber" value="${trip.customerNumber || ''}" class="modal-input" pattern="[0-9+\\-]*"></p>
            <p><strong>Driver Name:</strong> <input type="text" name="driverName" value="${trip.driverName || ''}" class="modal-input"></p>
            <p><strong>Driver Number:</strong> <input type="text" name="driverNumber" value="${trip.driverNumber || ''}" class="modal-input" pattern="[0-9+\\-]*"></p>
            <p><strong>Vehicle Model:</strong> <input type="text" name="vehicleModel" value="${trip.vehicleModel || ''}" class="modal-input"></p>
            <p><strong>Vehicle Number:</strong> <input type="text" name="vehicleNumber" value="${trip.vehicleNumber || ''}" class="modal-input"></p>
            <p><strong>Start Time:</strong> <input type="text" name="startTime" value="${formatTime12(trip.startTime) || ''}" class="modal-input" placeholder="HH:MM AM/PM"></p>
            <p><strong>End Time:</strong> <input type="text" name="endTime" value="${formatTime12(trip.endTime) || ''}" class="modal-input" placeholder="HH:MM AM/PM"></p>
            <p><strong>Duration:</strong> <input type="text" name="duration" value="${trip.duration || ''}" class="modal-input"></p>
            <p><strong>Extra Hours:</strong> <input type="number" name="extraHours" value="${trip.extraHours || ''}" class="modal-input" min="0"></p>
            <p><strong>Start KM:</strong> <input type="number" name="startKm" value="${trip.startKm || ''}" class="modal-input" min="0"></p>
            <p><strong>End KM:</strong> <input type="number" name="endKm" value="${trip.endKm || ''}" class="modal-input" min="0"></p>
            <p><strong>Total KM:</strong> <input type="number" name="totalKm" value="${trip.totalKm || ''}" class="modal-input" min="0"></p>
            <p><strong>Extra KM:</strong> <input type="number" name="extraKm" value="${trip.extraKm || ''}" class="modal-input" min="0"></p>
            <p><strong>Permit:</strong> <input type="text" name="parking" value="${trip.parking || ''}" class="modal-input"></p>
            <p><strong>Toll & Parking:</strong> <input type="text" name="toll" value="${trip.toll || ''}" class="modal-input"></p>
            <p><strong>Total Amount:</strong> <input type="number" name="totalAmount" value="${trip.totalAmount || ''}" class="modal-input" min="0" step="0.01"></p>
            <p><strong>Paid Amount:</strong> <input type="number" name="paidAmount" value="${trip.paidAmount || ''}" class="modal-input" min="0" step="0.01"></p>
            <p><strong>Payment Status:</strong> 
              <select name="paymentStatus" class="modal-input">
                <option value="" ${!trip.paymentStatus ? 'selected' : ''}>Select Status</option>
                <option value="Paid" ${trip.paymentStatus === 'Paid' ? 'selected' : ''}>Paid</option>
                <option value="Not Paid" ${trip.paymentStatus === 'Not Paid' ? 'selected' : ''}>Not Paid</option>
                <option value="Partially Paid" ${trip.paymentStatus === 'Partially Paid' ? 'selected' : ''}>Partially Paid</option>
              </select>
            </p>
            <p><strong>Notes:</strong> <textarea name="tripNotes" class="modal-input" rows="4">${trip.tripNotes || ''}</textarea></p>
            <p><strong>Files:</strong> <input type="text" name="tripFiles" value="${(trip.tripFiles || []).join(', ')}" class="modal-input" placeholder="Comma-separated URLs"></p>
          </form>
        `;
        editBtn.classList.add('hidden');
        deleteBtn.classList.add('hidden');
        saveBtn.classList.remove('hidden');
        cancelBtn.classList.remove('hidden');
      } else {
        modalContent.innerHTML = `
          <p><strong>Trip ID:</strong> ${trip.bookingId || ''}</p>
          <p><strong>Trip Dates:</strong> ${trip.tripDates}</p>
          <p><strong>Duty:</strong> ${trip.duty || ''}</p>
          <p><strong>Reference:</strong> ${trip.reference || ''}</p>
          <p><strong>Pickup:</strong> ${trip.pickupLocation || ''}</p>
          <p><strong>Drop:</strong> ${trip.dropLocation || ''}</p>
          <p><strong>Customer Name:</strong> ${trip.customerName || ''}</p>
          <p><strong>Customer Number:</strong> ${trip.customerNumber || ''}</p>
          <p><strong>Driver Name:</strong> ${trip.driverName || ''}</p>
          <p><strong>Driver Number:</strong> ${trip.driverNumber || ''}</p>
          <p><strong>Vehicle Model:</strong> ${trip.vehicleModel || ''}</p>
          <p><strong>Vehicle Number:</strong> ${trip.vehicleNumber || ''}</p>
          <p><strong>Start Time:</strong> ${formatTime12(trip.startTime)}</p>
          <p><strong>End Time:</strong> ${formatTime12(trip.endTime)}</p>
          <p><strong>Duration:</strong> ${trip.duration || ''}</p>
          <p><strong>Extra Hours:</strong> ${trip.extraHours || ''}</p>
          <p><strong>Start KM:</strong> ${trip.startKm || ''}</p>
          <p><strong>End KM:</strong> ${trip.endKm || ''}</p>
          <p><strong>Total KM:</strong> ${trip.totalKm || ''}</p>
          <p><strong>Extra KM:</strong> ${trip.extraKm || ''}</p>
          <p><strong>Permit:</strong> ${trip.parking || ''}</p>
          <p><strong>Toll & Parking:</strong> ${trip.toll || ''}</p>
          <p><strong>Total Amount:</strong> ${trip.totalAmount || ''}</p>
          <p><strong>Paid Amount:</strong> ${trip.paidAmount || ''}</p>
          <p><strong>Balance Amount:</strong> ${trip.balanceAmount || ''}</p>
          <p><strong>Payment Status:</strong> <span class="${statusClass}">${trip.paymentStatus || ''}</span></p>
          <p><strong>Notes:</strong> ${trip.tripNotes ? trip.tripNotes.replace(/\n/g, '<br>') : ''}</p>
          <p><strong>Files:</strong> ${
            trip.tripFiles && trip.tripFiles.length
              ? '<ul class="list-disc pl-5">' + trip.tripFiles.map(f => `<li><a href="${f}" target="_blank" class="file-link" aria-label="Open file ${f}">${f.split('/').pop()}</a></li>`).join('')
              : 'None'
          }</p>
        `;
        editBtn.classList.remove('hidden');
        deleteBtn.classList.remove('hidden');
        saveBtn.classList.add('hidden');
        cancelBtn.classList.add('hidden');
      }
      modal.style.display = 'flex';
    }

    // Save trip changes
    async function saveTrip() {
      const form = document.getElementById('editTripForm');
      const formData = new FormData(form);
      const updatedTrip = {
        bookingId: formData.get('bookingId') || currentTrip.bookingId,
        date: currentTrip.date || formData.get('tripDates').split(' to ')[0],
        duty: formData.get('duty') || '',
        reference: formData.get('reference') || '',
        pickupLocation: formData.get('pickupLocation') || '',
        dropLocation: formData.get('dropLocation') || '',
        customerName: formData.get('customerName') || '',
        customerNumber: formData.get('customerNumber') || '',
        driverName: formData.get('driverName') || '',
        driverNumber: formData.get('driverNumber') || '',
        vehicleModel: formData.get('vehicleModel') || '',
        vehicleNumber: formData.get('vehicleNumber') || '',
        startTime: parseTime12(formData.get('startTime')) || '',
        endTime: parseTime12(formData.get('endTime')) || '',
        duration: formData.get('duration') || '',
        extraHours: parseFloat(formData.get('extraHours')) || 0,
        startKm: parseFloat(formData.get('startKm')) || 0,
        endKm: parseFloat(formData.get('endKm')) || 0,
        totalKm: parseFloat(formData.get('totalKm')) || 0,
        extraKm: parseFloat(formData.get('extraKm')) || 0,
        parking: formData.get('parking') || '',
        toll: formData.get('toll') || '',
        totalAmount: parseFloat(formData.get('totalAmount')) || 0,
        paidAmount: parseFloat(formData.get('paidAmount')) || 0,
        balanceAmount: (parseFloat(formData.get('totalAmount')) || 0) - (parseFloat(formData.get('paidAmount')) || 0),
        paymentStatus: formData.get('paymentStatus') || '',
        tripNotes: formData.get('tripNotes') || '',
        tripFiles: formData.get('tripFiles') ? formData.get('tripFiles').split(',').map(f => f.trim()).filter(f => f) : []
      };

      // Validation
      if (!updatedTrip.bookingId) {
        alert('Trip ID is required.');
        return;
      }
      if (updatedTrip.totalAmount < updatedTrip.paidAmount) {
        alert('Paid Amount cannot exceed Total Amount.');
        return;
      }
      if (updatedTrip.customerNumber && !/^[0-9+\-]*$/.test(updatedTrip.customerNumber)) {
        alert('Invalid Customer Number.');
        return;
      }
      if (updatedTrip.driverNumber && !/^[0-9+\-]*$/.test(updatedTrip.driverNumber)) {
        alert('Invalid Driver Number.');
        return;
      }
      if (updatedTrip.startTime && !/^\d{2}:\d{2}$/.test(updatedTrip.startTime)) {
        alert('Invalid Start Time format (use HH:MM AM/PM).');
        return;
      }
      if (updatedTrip.endTime && !/^\d{2}:\d{2}$/.test(updatedTrip.endTime)) {
        alert('Invalid End Time format (use HH:MM AM/PM).');
        return;
      }

      try {
        document.querySelector('.modal-save').disabled = true;
        await set(ref(db, `trips/${updatedTrip.bookingId}`), updatedTrip);
        alert('Trip updated successfully.');
        document.getElementById('tripModal').style.display = 'none';
        await loadTrips();
      } catch (error) {
        alert('Error updating trip: ' + error.message);
      } finally {
        document.querySelector('.modal-save').disabled = false;
      }
    }

    // Delete trip
    async function deleteTrip(bookingId) {
      if (!confirm(`Are you sure you want to delete trip ${bookingId}? This will remove all related records for this booking.`)) {
        return;
      }
      try {
        document.querySelector('.modal-delete').disabled = true;
        await remove(ref(db, `trips/${bookingId}`));
        alert('Trip deleted successfully.');
        document.getElementById('tripModal').style.display = 'none';
        await loadTrips();
      } catch (error) {
        alert('Error deleting trip: ' + error.message);
      } finally {
        document.querySelector('.modal-delete').disabled = false;
      }
    }

    // Modal event listeners
    document.querySelector('.modal-close').addEventListener('click', () => {
      document.getElementById('tripModal').style.display = 'none';
    });
    document.querySelector('.modal-edit').addEventListener('click', () => {
      showTripModal(currentTrip, true);
    });
    document.querySelector('.modal-save').addEventListener('click', saveTrip);
    document.querySelector('.modal-cancel').addEventListener('click', () => {
      showTripModal(currentTrip, false);
    });
    document.querySelector('.modal-delete').addEventListener('click', () => {
      deleteTrip(currentTrip.bookingId);
    });
    document.getElementById('tripModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('tripModal')) {
        document.getElementById('tripModal').style.display = 'none';
      }
    });

    // Render table with filters/search/sort and sum row
    function renderTable() {
      const tbody = document.getElementById('tripTableBody');
      const tfoot = document.getElementById('sumRow');
      tbody.innerHTML = '';
      tfoot.innerHTML = '';
      const search = document.getElementById('searchInput').value.toLowerCase();
      const driver = document.getElementById('driverFilter').value;
      const vehicle = document.getElementById('vehicleFilter').value;
      const payment = document.getElementById('paymentFilter').value;
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;

      let filtered = groupTrips(allTrips).filter(trip => {
        let match = true;
        if (search) {
          match = Object.values(trip).some(val =>
            (val + '').toLowerCase().includes(search)
          );
        }
        if (match && driver) match = trip.driverName === driver;
        if (match && vehicle) match = trip.vehicleModel === vehicle;
        if (match && payment) match = trip.paymentStatus === payment;
        if (match && fromDate) {
          if (trip.tripDates.includes(' to ')) {
            const [startDateStr] = trip.tripDates.split(' to ');
            const startDate = parseDateDDMMYYYY(startDateStr);
            match = startDate && startDate >= new Date(fromDate);
          } else {
            const tripDate = parseDateDDMMYYYY(trip.tripDates);
            match = tripDate && tripDate >= new Date(fromDate);
          }
        }
        if (match && toDate) {
          if (trip.tripDates.includes(' to ')) {
            const [, endDateStr] = trip.tripDates.split(' to ');
            const endDate = parseDateDDMMYYYY(endDateStr);
            match = endDate && endDate <= new Date(toDate);
          } else {
            const tripDate = parseDateDDMMYYYY(trip.tripDates);
            match = tripDate && tripDate <= new Date(toDate);
          }
        }
        return match;
      });

      // Sort
      if (sortCol !== null) {
        filtered.sort((a, b) => {
          let valA = a[colKeys[sortCol]];
          let valB = b[colKeys[sortCol]];
          if (colKeys[sortCol] === "tripDates") {
            valA = a.date || (a.tripDates.includes(' to ') ? a.tripDates.split(' to ')[0] : a.tripDates);
            valB = b.date || (b.tripDates.includes(' to ') ? b.tripDates.split(' to ')[0] : b.tripDates);
            valA = parseDateDDMMYYYY(valA);
            valB = parseDateDDMMYYYY(valB);
            if (valA && valB) return (valA - valB) * sortDir;
            if (valA) return sortDir;
            if (valB) return -sortDir;
            return 0;
          }
          if (!isNaN(valA) && !isNaN(valB)) {
            return (Number(valA) - Number(valB)) * sortDir;
          }
          if (valA && valB) {
            return valA.toString().localeCompare(valB.toString()) * sortDir;
          }
          if (valA) return sortDir;
          if (valB) return -sortDir;
          return 0;
        });
      }

      // Sums
      let totalAmount = 0, paidAmount = 0, balanceAmount = 0;
      filtered.forEach(trip => {
        totalAmount += parseFloat(trip.totalAmount) || 0;
        paidAmount += parseFloat(trip.paidAmount) || 0;
        balanceAmount += parseFloat(trip.balanceAmount) || 0;
      });

      filtered.forEach(trip => {
        let statusClass = '';
        if (trip.paymentStatus === 'Paid') statusClass = 'status-badge status-paid';
        else if (trip.paymentStatus === 'Not Paid') statusClass = 'status-badge status-notpaid';
        else if (trip.paymentStatus === 'Partially Paid') statusClass = 'status-badge status-partial';
        else statusClass = '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${trip.bookingId || ''}</td>
          <td class="trip-date-col">${trip.tripDates}</td>
          <td>${trip.duty || ''}</td>
          <td>${trip.reference || ''}</td>
          <td>${trip.pickupLocation || ''}</td>
          <td>${trip.dropLocation || ''}</td>
          <td>${trip.customerName || ''}</td>
          <td>${trip.customerNumber || ''}</td>
          <td>${trip.driverName || ''}</td>
          <td>${trip.driverNumber || ''}</td>
          <td>${trip.vehicleModel || ''}</td>
          <td>${trip.vehicleNumber || ''}</td>
          <td>${formatTime12(trip.startTime)}</td>
          <td>${formatTime12(trip.endTime)}</td>
          <td>${trip.duration || ''}</td>
          <td>${trip.extraHours || ''}</td>
          <td>${trip.startKm || ''}</td>
          <td>${trip.endKm || ''}</td>
          <td>${trip.totalKm || ''}</td>
          <td>${trip.extraKm || ''}</td>
          <td>${trip.parking || ''}</td>
          <td>${trip.toll || ''}</td>
          <td>${trip.totalAmount || ''}</td>
          <td>${trip.paidAmount || ''}</td>
          <td>${trip.balanceAmount || ''}</td>
          <td><span class="${statusClass}">${trip.paymentStatus || ''}</span></td>
          <td>${trip.tripNotes ? trip.tripNotes.replace(/\n/g, '<br>') : ''}</td>
          <td>${
            trip.tripFiles && trip.tripFiles.length
              ? trip.tripFiles.map(f => `<a href="${f}" target="_blank" class="file-link inline-block bg-gray-200 dark:bg-gray-700 rounded px-2 py-1 m-1" aria-label="Open file ${f}">${f.split('/').pop()}</a>`).join('')
              : ''
          }</td>
        `;
        tr.addEventListener('click', () => showTripModal(trip));
        tbody.appendChild(tr);
      });

      // Sum row
      let sumRow = `
        <td class="sum-row">Total</td>
        <td class="sum-row" colspan="21"></td>
        <td class="sum-row">${totalAmount.toFixed(2)}</td>
        <td class="sum-row">${paidAmount.toFixed(2)}</td>
        <td class="sum-row">${balanceAmount.toFixed(2)}</td>
        <td class="sum-row" colspan="3"></td>
      `;
      tfoot.innerHTML = sumRow;
    }

    // Event listeners for filters/search with debounced search
    const debouncedRenderTable = debounce(renderTable, 300);
    document.getElementById('searchInput').addEventListener('input', debouncedRenderTable);
    document.getElementById('driverFilter').addEventListener('change', renderTable);
    document.getElementById('vehicleFilter').addEventListener('change', renderTable);
    document.getElementById('paymentFilter').addEventListener('change', renderTable);
    document.getElementById('fromDate').addEventListener('change', renderTable);
    document.getElementById('toDate').addEventListener('change', renderTable);
    document.getElementById('clearFilters').addEventListener('click', function() {
      document.getElementById('searchInput').value = '';
      document.getElementById('driverFilter').value = '';
      document.getElementById('vehicleFilter').value = '';
      document.getElementById('paymentFilter').value = '';
      document.getElementById('fromDate').value = '';
      document.getElementById('toDate').value = '';
      renderTable();
    });

    // Export to PDF
    document.getElementById('exportPDF').addEventListener('click', function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: "landscape",
        unit: "pt",
        format: [1684, 1190]
      });
      const head = [
        [
          "Trip ID", "Trip Dates", "Duty", "Reference", "Pickup", "Drop", "Customer Name", "Customer Number",
          "Driver Name", "Driver Number", "Vehicle Model", "Vehicle Number", "Start Time", "End Time", "Duration",
          "Extra Hours", "Start KM", "End KM", "Total KM", "Extra KM", "Permit", "Toll & Parking", "Total Amount",
          "Paid Amount", "Balance Amount", "Payment Status", "Notes", "Files"
        ]
      ];
      const body = [];
      const search = document.getElementById('searchInput').value.toLowerCase();
      const driver = document.getElementById('driverFilter').value;
      const vehicle = document.getElementById('vehicleFilter').value;
      const payment = document.getElementById('paymentFilter').value;
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;

      let filtered = groupTrips(allTrips).filter(trip => {
        let match = true;
        if (search) {
          match = Object.values(trip).some(val =>
            (val + '').toLowerCase().includes(search)
          );
        }
        if (match && driver) match = trip.driverName === driver;
        if (match && vehicle) match = trip.vehicleModel === vehicle;
        if (match && payment) match = trip.paymentStatus === payment;
        if (match && fromDate) {
          if (trip.tripDates.includes(' to ')) {
            const [startDateStr] = trip.tripDates.split(' to ');
            const startDate = parseDateDDMMYYYY(startDateStr);
            match = startDate && startDate >= new Date(fromDate);
          } else {
            const tripDate = parseDateDDMMYYYY(trip.tripDates);
            match = tripDate && tripDate >= new Date(fromDate);
          }
        }
        if (match && toDate) {
          if (trip.tripDates.includes(' to ')) {
            const [, endDateStr] = trip.tripDates.split(' to ');
            const endDate = parseDateDDMMYYYY(endDateStr);
            match = endDate && endDate <= new Date(toDate);
          } else {
            const tripDate = parseDateDDMMYYYY(trip.tripDates);
            match = tripDate && tripDate <= new Date(toDate);
          }
        }
        return match;
      });

      // Sums
      let totalAmount = 0, paidAmount = 0, balanceAmount = 0;
      filtered.forEach(trip => {
        totalAmount += parseFloat(trip.totalAmount) || 0;
        paidAmount += parseFloat(trip.paidAmount) || 0;
        balanceAmount += parseFloat(trip.balanceAmount) || 0;
      });

      filtered.forEach(trip => {
        body.push([
          trip.bookingId || '',
          trip.tripDates,
          trip.duty || '',
          trip.reference || '',
          trip.pickupLocation || '',
          dropLocation || '',
          trip.customerName || '',
          trip.customerNumber || '',
          trip.driverName || '',
          trip.driverNumber || '',
          trip.vehicleModel || '',
          trip.vehicleNumber || '',
          formatTime12(trip.startTime),
          formatTime12(trip.endTime),
          trip.duration || '',
          trip.extraHours || '',
          trip.startKm || '',
          trip.endKm || '',
          trip.totalKm || '',
          trip.extraKm || '',
          trip.parking || '',
          trip.toll || '',
          trip.totalAmount || '',
          trip.paidAmount || '',
          trip.balanceAmount || '',
          trip.paymentStatus || '',
          trip.tripNotes ? trip.tripNotes.replace(/\n/g, ' ') : '',
          (trip.tripFiles && trip.tripFiles.length) ? trip.tripFiles.join(', ') : ''
        ]);
      });

      // Add sum row
      let sumRow = [];
      for (let i = 0; i < 28; i++) {
        if (i === 22) sumRow.push(totalAmount.toFixed(2));
        else if (i === 23) sumRow.push(paidAmount.toFixed(2));
        else if (i === 24) sumRow.push(balanceAmount.toFixed(2));
        else if (i === 0) sumRow.push("Total");
        else sumRow.push("");
      }
      body.push(sumRow);

      doc.autoTable({
        head: head,
        body: body,
        startY: 40,
        styles: { font: "helvetica", fontSize: 12, cellPadding: 5, halign: 'center', valign: 'middle' },
        headStyles: { fillColor: [37, 99, 235], textColor: 255, fontStyle: 'bold', halign: 'center', valign: 'middle' },
        alternateRowStyles: { fillColor: [245, 245, 245] },
        margin: { left: 10, right: 10 },
        theme: 'grid',
        didDrawPage: function (data) {
          doc.setFontSize(18);
          doc.setTextColor(40);
          doc.text("Trip Summary - NST Travels", data.settings.margin.left + 20, 28, { align: 'left' });
        },
        didParseCell: function (data) {
          if (data.row.index === body.length - 1 && data.section === 'body') {
            data.cell.styles.fontStyle = 'bold';
            data.cell.styles.fillColor = [224, 231, 255];
            data.cell.styles.textColor = [30, 64, 175];
          }
        }
      });
      doc.save('trip-summary.pdf');
    });

    // Export to Excel
    document.getElementById('exportExcel').addEventListener('click', function() {
      const table = document.getElementById('tripTable');
      const wb = XLSX.utils.table_to_book(table, {sheet:"Trips"});
      XLSX.writeFile(wb, 'trip-summary.xlsx');
    });

    // Column resizing
    function makeColumnsResizable(table) {
      const ths = table.querySelectorAll('th');
      ths.forEach((th, i) => {
        const handle = th.querySelector('.resize-handle');
        if (!handle) return;
        let startX, startWidth;
        handle.addEventListener('mousedown', function(e) {
          e.preventDefault();
          startX = e.clientX;
          startWidth = th.offsetWidth;
          document.body.style.cursor = 'col-resize';
          function onMouseMove(ev) {
            let newWidth = startWidth + (ev.clientX - startX);
            if (newWidth < 40) newWidth = 40;
            th.style.width = newWidth + "px";
            table.querySelectorAll('tr').forEach(row => {
              if (row.children[i]) row.children[i].style.width = newWidth + "px";
            });
          }
          function onMouseUp() {
            document.body.style.cursor = '';
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
          }
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
    }

    // Sorting
    function makeColumnsSortable(table) {
      const ths = table.querySelectorAll('th');
      ths.forEach((th, i) => {
        th.addEventListener('click', function(e) {
          if (e.target.classList.contains('resize-handle')) return;
          if (sortCol === i) {
            sortDir = -sortDir;
          } else {
            sortCol = i;
            sortDir = 1;
          }
          ths.forEach(t => t.classList.remove('sorted-asc', 'sorted-desc'));
          th.classList.add(sortDir === 1 ? 'sorted-asc' : 'sorted-desc');
          renderTable();
        });
      });
    }

    // Initial load
    loadTrips();

    // After DOM loaded, make columns resizable and sortable
    window.addEventListener('DOMContentLoaded', () => {
      const table = document.getElementById('tripTable');
      makeColumnsResizable(table);
      makeColumnsSortable(table);
    });
  </script>
</body>
</html>
